---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-yamllint-fail
  annotations:
    test/assert-task-failure: "run-yamllint"
spec:
  description: |
    Test that the yaml-lint task fails when given invalid YAML files.
    This test is expected to fail on the run-yamllint task.
  tasks:
    - name: setup-test-repo
      taskSpec:
        volumes:
          - name: git-repos
            persistentVolumeClaim:
              claimName: git-repos
        steps:
          - name: create-test-repo
            image: quay.io/konflux-qe-incubator/konflux-qe-tools:latest
            volumeMounts:
              - name: git-repos
                mountPath: /git-repos
            script: |
              #!/bin/bash
              set -e

              # Clean up any existing test repo
              rm -rf /git-repos/test-repo-fail

              # Create test directory in the PVC
              mkdir -p /git-repos/test-repo-fail
              cd /git-repos/test-repo-fail

              # Create invalid YAML file with duplicate keys
              cat > invalid.yaml <<'EOF'
              ---
              apiVersion: v1
              kind: ConfigMap
              metadata:
                name: test-config
              data:
                key1: value1
                key1: duplicate-key
              EOF

              # Initialize git repo
              git init
              git config user.email "test@example.com"
              git config user.name "Test User"
              git add invalid.yaml
              git commit -m "Add invalid YAML"
              git branch -M main

              echo "Test repository created at /git-repos/test-repo-fail"

              # Signal to git-daemon that repos are ready (if not already signaled)
              mkdir -p /git-repos/.initialized
              echo "Repos initialized" > /git-repos/.initialized/marker

              # Wait for git-daemon to start serving (needs time to install git-daemon package)
              echo "Waiting for git-daemon to start..."
              sleep 15

    - name: run-yamllint
      runAfter:
        - setup-test-repo
      taskRef:
        name: yaml-lint
      params:
        - name: git-url
          value: "git://git-daemon.yaml-lint-0-1.svc.cluster.local:9418/test-repo-fail"
        - name: git-revision
          value: "main"
