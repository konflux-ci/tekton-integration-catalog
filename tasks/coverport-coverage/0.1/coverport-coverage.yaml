---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: coverport-coverage
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.56.0"
    tekton.dev/categories: Testing
    tekton.dev/tags: coverage,testing,codecov,sonarcloud
    tekton.dev/displayName: "Coverport - Collect and Upload Coverage"
spec:
  description: |
    Collects coverage from Konflux Integration tests and uploads to coverage services.

    1. Collects coverage from test pods and creates metadata.json manifest (coverport-collect)
    2. Pushes raw coverage + manifest to OCI registry (secure-push-oci)
    3. Batch processes all components and uploads to Codecov (coverport-upload)

    Designed to integrate with Konflux Integration pipelines.

    Uses onError: continue to ensure pipeline doesn't fail on coverage issues.

  params:
    - name: instrumented-images
      description: |
        Comma-separated list of instrumented container image references.
        These are the test images built with coverage instrumentation, NOT the production images from SNAPSHOT.
        Example: "quay.io/org/app-instrumented@sha256:abc,quay.io/org/service-instrumented@sha256:def"
      type: string
      default: "quay.io/redhat-user-workloads-stage/psturc-tenant/go-coverage-http:ee282f9ede36db993d3b3d1e3da4bbd090f5f915"
    
    - name: cluster-access-secret-name
      description: |
        Secret containing kubeconfig to access the testing cluster (where the instrumented images are running).
        Leave empty to use in-cluster config.
      type: string
    
    - name: test-namespace
      description: |
        Kubernetes namespace where test pods are running.
        Leave empty to search all non-system namespaces.
      type: string
      default: ""
    
    - name: test-name
      description: |
        Name for this test run (used in artifact naming and identification).
        If empty, auto-generated based on timestamp.
      type: string
      default: "e2e-tests"
    
    - name: oci-container
      description: |
        OCI container reference where artifacts will be stored.
        Example: "quay.io/org/test-artifacts:tag"
      type: string
    
    - name: upload-target
      description: |
        Coverage upload target: "codecov", "sonarcloud" (will be added in the future)
        Default is codecov only.
      type: string
      default: "codecov"
    
    - name: codecov-flags
      description: |
        Comma-separated list of Codecov flags for categorizing coverage.
        Example: "e2e-tests,integration"
      type: string
      default: "e2e-tests"
    
    - name: credentials-secret-name
      description: |
        Secret containing OCI registry credentials for pushing artifacts.
        Required for secure-push-oci step.
      type: string
      default: "coverport-secrets"
  
  results:
    - name: coverage-collected
      description: Number of components with coverage collected
    
    - name: coverage-uploaded
      description: Number of components successfully uploaded
    
    - name: total-coverage
      description: Total coverage percentage across all components
  
  volumes:
    - name: cluster-credentials
      secret:
        secretName: $(params.cluster-access-secret-name)
        optional: true
    - name: coverage-secrets-volume
      secret:
        secretName: coverport-secrets
        optional: true
    - name: oci-credentials-volume
      secret:
        secretName: $(params.credentials-secret-name)
        optional: true

  stepTemplate:
    env:
      - name: KUBECONFIG
        value: /cluster-credentials/kubeconfig
    volumeMounts:
      - name: cluster-credentials
        mountPath: /cluster-credentials

  steps:
    # Step 1: Collect coverage from test pods
    - name: collect-coverage
      onError: continue
      ref:
        # name: coverport-collect
        resolver: git
        params:
          - name: url
          # revert once related changes are merged to main
            value: https://github.com/psturc/tekton-integration-catalog.git
          - name: revision
          # revert once related changes are merged to main
            value: KFLUXDP-591
          - name: pathInRepo
            value: stepactions/coverport-collect/0.1/coverport-collect.yaml
      params:
        - name: images
          value: $(params.instrumented-images)
        - name: namespace
          value: $(params.test-namespace)
        - name: test-name
          value: $(params.test-name)
        - name: output-path
          value: /workspace/coverage
        - name: generate-reports
          value: "true"
        - name: verbose
          value: "false"
    
    # Step 2: Push coverage artifacts to OCI registry
    - name: push-artifacts-to-oci
      ref:
        resolver: git
        params:
          - name: url
            value: https://github.com/konflux-ci/tekton-integration-catalog.git
          - name: revision
            value: main
          - name: pathInRepo
            value: stepactions/secure-push-oci/0.1/secure-push-oci.yaml
      params:
        - name: workdir-path
          value: /workspace/coverage
        - name: oci-ref
          value: $(params.oci-container)
        - name: credentials-volume-name
          value: oci-credentials-volume
    
    # Step 3: Process and upload coverage to services
    # Note: Uses manifest-based workflow - automatically processes all components
    # from the metadata.json manifest created by coverport-collect
    - name: upload-coverage
      onError: continue
      ref:
        # name: coverport-upload
        resolver: git
        params:
          - name: url
          # revert once related changes are merged to main
            value: https://github.com/psturc/tekton-integration-catalog.git
          - name: revision
          # revert once related changes are merged to main
            value: KFLUXDP-591
          - name: pathInRepo
            value: stepactions/coverport-upload/0.1/coverport-upload.yaml
      params:
        - name: coverage-path
          value: $(steps.collect-coverage.results.coverage-path)
        - name: upload-codecov
          value: "true"
        - name: codecov-flags
          value: $(params.codecov-flags)
        - name: verbose
          value: "false"

