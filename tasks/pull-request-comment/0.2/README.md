# Pull Request Commenter Task

**Version:** 0.2

## Overview

The **Pull Request Commenter Task** automatically posts a comment on a GitHub pull request, providing important details about the execution of a Tekton pipeline.

### Features

- Summarizes the pipeline run status in a PR comment.
- Provides links to build logs and test artifacts.
- Allows re-running failed tests with a simple command (`/retest`).
- (Optional) Enables **Test Results Analysis** to help diagnose failures automatically.

## Parameters

| Name | Description | Default Value | Required |
|------|------------|--------------|----------|
| `test-name` | The name of the pipeline run being executed. | N/A | ✅ Yes |
| `oci-container` | The ORAS container registry URI where the test artifacts are stored. | N/A | ✅ Yes |
| `job-spec` | Job specification for this PipelineRun, generated by the [test-metadata](../../test-metadata/0.2/test-metadata.yaml) task. | N/A | ✅ Yes |
| `pipeline-aggregate-status` | The aggregate status of the pipeline run (Succeeded, Failed, Completed, None). | None | ✅ Yes |
| `enable-test-results-analysis` | Set to `true` to enable experimental test results analysis. | `false` | ❌ No |
| `junit-report-name` | JUnit file report name for analysis. | `junit.xml` | ✅ Yes |
| `e2e-log-name` | The name of the log file from end-to-end tests. | `e2e-tests.log` | ✅ Yes |
| `cluster-provision-log-name` | The name of the log file from cluster provisioning. | `cluster-provision.log` | ✅ Yes |
| `artifact-browser-url` | Provides the URL to the artifact browser deployment. | "" | ❌ No |

## Results

This task does not produce any direct results but provides valuable insights through GitHub PR comments.

## Example Use Case

When a pipeline execution completes, this task:

1. Deletes any previous comments made by the bot on the pull request.
2. If the pipeline **succeeded**, no new comment is posted.
3. If the pipeline **failed**, a comment is posted with:
   - Pipeline status
   - Links to pipeline logs and test artifacts
   - Instructions for downloading test artifacts using ORAS
   - (Optional) An automated analysis of test failures

## Enabling Test Results Analysis

To enable the experimental **Test Results Analysis**, set `enable-test-results-analysis` to `true`. The analysis step will:

- Scan logs and reports stored in the specified OCI artifact.
- Identify potential causes of test failures.
- Append the analysis summary to the PR comment.

## Enabling OCI Artifact Browser

To enable the **OCI Artifact Browser**, provide the artifact browser deployment URL via the `artifact-browser-url` parameter. When a URL is provided, the task will generate a direct link to the specific test artifacts in the PR comment.

If the parameter is empty or not provided, no artifact browser link will be included in the comment.

## Additional Notes

- The task requires a GitHub token (stored in a secret) to authenticate and post comments.
- Ensure ORAS is installed if you need to retrieve test artifacts.
- Use `/retest` in the PR comment to trigger a rerun of failed tests.
